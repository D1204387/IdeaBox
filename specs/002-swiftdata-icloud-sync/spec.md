# Feature Specification: 整合 SwiftData 與 iCloud 同步

**Feature Branch**: `002-swiftdata-icloud-sync`  
**Created**: 2025-11-10  
**Status**: Draft  
**Input**: User description: "把整個app改成SwiftData,然後需要同步到iCloud"

## User Scenarios & Testing *(mandatory)*

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.
  
  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently
-->

### User Story 1 - SwiftData 本地持久化 (Priority: P1)

應用程式使用 SwiftData 框架替代模擬數據，將使用者建立的想法持久化儲存到本機。即使應用程式被關閉或重新啟動，使用者建立的所有想法都應保持存在。

**為什麼是 P1**：這是整個功能的基礎。不實現本地持久化，iCloud 同步就無法進行。這是 MVP 的必要條件。

**獨立測試**：在應用程式中新增一個想法、關閉應用程式、重新開啟應用程式，確認新增的想法仍然存在。無需任何 iCloud 帳戶或網路連接。

**驗收情景**：

1. **Given** 應用程式啟動且無任何想法, **When** 使用者新增一個想法, **Then** 想法被保存到本機存儲
2. **Given** 使用者已新增想法, **When** 應用程式被完全關閉, **Then** 重新啟動應用程式後想法仍然存在
3. **Given** 使用者已建立多個想法, **When** 使用者標記一個想法為完成, **Then** 完成狀態被立即保存到本機
4. **Given** 使用者已建立想法, **When** 使用者刪除一個想法, **Then** 刪除操作被立即保存到本機

---

### User Story 2 - iCloud 帳戶配置與同步初始化 (Priority: P2)

應用程式支援使用者透過他們的 iCloud 帳戶進行資料同步。當使用者登入 iCloud 時，應用程式應自動建立必要的 CloudKit 容器並初始化同步機制。

**為什麼是 P2**：在本地持久化工作後，這是啟用 iCloud 同步的基礎設施層。確保帳戶連接和同步機制就緒。

**獨立測試**：在具有有效 iCloud 帳戶登入的 iOS 模擬器或裝置上執行應用程式，確認應用程式檢測到帳戶並啟動同步機制，無需實際同步資料。

**驗收情景**：

1. **Given** 使用者已登入有效的 iCloud 帳戶, **When** 應用程式啟動, **Then** 應用程式檢測到帳戶並初始化同步
2. **Given** iCloud 帳戶尚未登入, **When** 應用程式啟動, **Then** 應用程式以離線模式運行，提示使用者登入以啟用同步
3. **Given** 使用者已啟用 iCloud 同步, **When** 應用程式啟動, **Then** 應用程式從 iCloud 下載任何遠端變更

---

### User Story 3 - 多裝置資料同步 (Priority: P2)

一旦使用者在一個裝置上建立、修改或刪除想法，這些變更應自動同步到該使用者其他登入相同 iCloud 帳戶的裝置。

**為什麼是 P2**：提供跨裝置的無縫體驗。當 P1 和 P2 的基礎設施就緒後，此功能會自動啟用。

**獨立測試**：在兩個同時執行的模擬器上（均使用相同的 iCloud 帳戶），在其中一個上新增想法，在 10 秒內驗證該想法是否出現在另一個上。

**驗收情景**：

1. **Given** 兩個裝置均登入相同的 iCloud 帳戶, **When** 使用者在裝置 A 上新增想法, **Then** 該想法在 10 秒內出現在裝置 B 上
2. **Given** 使用者在裝置 A 上建立想法, **When** 使用者在裝置 B 上標記該想法為完成, **Then** 完成狀態在 10 秒內同步回裝置 A
3. **Given** 想法在多個裝置上同步, **When** 使用者在裝置 A 上刪除想法, **Then** 刪除操作在 10 秒內同步到其他裝置

---

### User Story 4 - 離線與衝突處理 (Priority: P3)

當使用者在沒有網路連接的情況下修改想法時，應用程式應在本機保存變更。當網路恢復時，應用程式應自動嘗試與 iCloud 同步。如果發生衝突（同一想法在多個裝置上同時編輯），應自動進行合理的解決。

**為什麼是 P3**：這提供了更強大的錯誤處理和使用者體驗。基本的同步功能（P1-P2）完成後可以添加。

**獨立測試**：在無網路連接的狀況下於應用程式中進行想法編輯，驗證變更被本機保存。然後恢復網路，驗證變更最終與 iCloud 同步。

**驗收情景**：

1. **Given** 網路連接中斷, **When** 使用者新增或編輯想法, **Then** 變更在本機保存
2. **Given** 變更在離線時被保存, **When** 網路連接恢復, **Then** 應用程式自動嘗試同步變更
3. **Given** 同一想法在兩個裝置上同時編輯, **When** 變更嘗試同步, **Then** 最新的時間戳版本獲勝

---

### User Story 3 - [Brief Title] (Priority: P3)

[Describe this user journey in plain language]

**Why this priority**: [Explain the value and why it has this priority level]

**Independent Test**: [Describe how this can be tested independently]

**Acceptance Scenarios**:

1. **Given** [initial state], **When** [action], **Then** [expected outcome]

---

### 邊界情況

- 當使用者在離線狀態下新增大量想法（超過 1000 個）時會發生什麼？
- 應用程式在同步過程中被強制關閉時如何處理？
- 當 iCloud 帳戶在應用程式執行中被切換時會發生什麼？
- 如果本地資料庫損毀或無法讀取會發生什麼？
- 當 iCloud 存儲空間已滿時應如何提示使用者？
- 超過 30 天未同步的舊版本資料應如何處理？

## 需求 *(必須)*

### 功能需求

- **FR-001**：系統必須將 `Idea` 模型遷移為 SwiftData `@Model`，保留所有現有屬性（id、title、description、isCompleted）
- **FR-002**：系統必須支援本地資料持久化，使用 SwiftData 和 ModelContext
- **FR-003**：系統必須初始化 CloudKit 容器以支援 iCloud 同步
- **FR-004**：系統必須檢測使用者 iCloud 帳戶登入狀態，並在離線模式與同步模式之間自動切換
- **FR-005**：系統必須在 10 秒內同步多個裝置之間的想法變更
- **FR-006**：系統必須在網路恢復時自動同步離線期間的本機變更
- **FR-007**：系統必須使用時間戳和衝突解決策略（最新時間戳優先）來處理同時編輯衝突
- **FR-007-詳細**：衝突解決在記錄層級進行（完整 Idea 物件）；較新的 updatedAt 時間戳版本覆寫舊版本；不進行字段級別的合併
- **FR-008**：系統必須保留審計日誌記錄每次變更（建立、修改、刪除的時間戳和源裝置）
- **FR-009**：系統必須維持所有現有的 UI 功能（搜尋、篩選、刪除、完成狀態標記）
- **FR-010**：系統必須在 iCloud 同步失敗時提供清晰的使用者反饋（錯誤訊息、重試選項）
- **FR-010-詳細**：同步失敗後自動重試 3 次，延遲間隔為 1 秒、2 秒、4 秒（指數退避）；3 次重試後仍失敗則停止重試，在離線模式下保留變更，等待網路恢復
- **FR-011**：系統必須使用按需同步 + 背景更新的策略：使用者動作立即觸發同步，批次大小最多 100 筆變更，無冷卻期；背景更新由 iOS 系統管理
- **FR-012**：系統必須在首次啟動時自動偵測並遷移舊版本模擬數據到 SwiftData；遷移失敗時回退到離線模式，下次啟動時自動重試
- **FR-013**：系統必須實現指數退避重試邏輯：同步失敗後自動重試 3 次，延遲間隔分別為 1 秒、2 秒、4 秒；3 次重試後停止，保留離線變更直到網路恢復
- **FR-014**：系統必須使用毫秒精度的時間戳進行版本控制、衝突解決和同步跨度追蹤；30 天未同步的版本標記為"已過時"但保留用於審計和恢復

### 關鍵實體

- **Idea**：表示使用者建立的想法，具有 id（UUID）、title（字符串）、description（字符串）、isCompleted（布林）、createdAt（時間戳，毫秒精度）、updatedAt（時間戳，毫秒精度）、deviceId（來源裝置識別符）
- **SyncState**：追蹤每個想法的同步狀態，包括本地版本號、遠端版本號、最後同步時間、待同步標誌、已過時標誌（30 天未同步時設定）
- **CloudKitContainer**：管理與 iCloud 的連接，追蹤帳戶狀態和同步進度

## 成功標準 *(必須)*

### 可測量的成果

- **SC-001**：使用者可在離線狀態下建立想法，重新啟動應用程式後想法仍存在（本機持久化成功率 100%）
- **SC-002**：多裝置間的想法變更在 10 秒內同步（同步延遲 P95 < 10 秒）
- **SC-003**：應用程式支援至少 10,000 個想法的本地儲存而不出現性能下降
- **SC-004**：iCloud 同步失敗時（網路中斷、帳戶切換等），應用程式能自動恢復並在恢復後重試，成功率 > 95%
- **SC-005**：應用程式啟動時間不超過 2 秒（即使有 10,000 個想法需要載入）
- **SC-006**：使用者可在同步進行中繼續與應用程式互動（非阻塞同步）
- **SC-007**：衝突情況下，自動解決成功率 > 99%（基於時間戳優先策略，毫秒精度）
- **SC-008**：離線模式下新增的想法，在網路恢復後 100% 成功同步到 iCloud；同步失敗後自動重試，最多 3 次，指數退避間隔 1s→2s→4s
- **SC-009**：對現有用戶而言，功能完全相同，無視覺或交互上的變化（除了持久化現在透過 SwiftData 而非模擬數據）
- **SC-010**：應用程式電量消耗不增加超過 5%（相比於當前的模擬數據版本）

## 假設與限制

### 假設

- **部署環境**：最低 iOS 17（SwiftData 最低需求）；由於專案當前目標 iOS 26+，此限制已滿足
- **iCloud 帳戶**：使用者已在 iOS 系統設定中登入有效的 iCloud 帳戶以啟用同步；無帳戶時應用程式仍可離線運行
- **數據遷移**：現有的 Phase 1 模擬數據（7 個示例想法）應在首次啟動時自動遷移到 SwiftData；遷移失敗時應用程式回退到離線模式，下次啟動時自動重試；遷移時的 createdAt 和 updatedAt 使用當前系統時間；此策略確保平滑升級和無資料損失
- **網路情況**：同步操作假設在合理的網路條件下進行（3G/4G/5G 或 WiFi）；極端網路延遲（>30 秒）應被視為超時失敗
- **並發編輯**：同一想法在不同裝置上被同時編輯的情況較為罕見；衝突解決採用簡單的「最後寫入獲勝」策略
- **雲存儲容限**：假設每個 iCloud 帳戶有足夠的存儲空間；超出時應提示使用者而非靜默失敗

### 範圍與邊界

- **本次功能不包括**：
  - 編輯現有想法的功能（Plan 已記錄為 Phase 3）
  - 想法分類、標籤或高級搜尋（Phase 3）
  - 共享想法給其他使用者
  - 想法版本歷史查看
  - 自訂衝突解決策略的用戶界面

- **本次功能包括**：
  - 建立、標記完成、刪除想法的完整持久化
  - 自動的雙向 iCloud 同步
  - 離線支援
  - 自動衝突解決

## 與現有功能的相容性

本特性旨在保持 100% 的用戶可視化和交互相容性。所有現有的 UI、標籤頁、搜尋和篩選功能應完全相同，差異僅在於數據源從模擬數據變更為 SwiftData + iCloud。這符合 IdeaBox 憲法中「最小可行產品優先」和「簡單勝於複雜」的原則。

## 澄清

### Session 2025-11-10

- **Q1: CloudKit 配額與同步策略** → **A: 按需同步 + 背景更新（選項 B）**
  - 同步被觸發於：使用者動作（新增、編輯、刪除）、應用程式進入前景、系統觸發的背景更新
  - 批次大小：單次 CloudKit 操作最多 100 筆想法變更
  - 同步頻率：按需觸發無冷卻時間；背景更新由 iOS 系統管理（通常 15-30 分鐘）
  - 這確保 P95 延遲 < 10 秒（使用者發起的同步）且電池效率最佳

- **Q2: 版本控制與衝突解決策略** → **A: 記錄級別衝突解決（選項 A）**
  - 衝突檢測在記錄層級進行（整個 Idea 物件）
  - 當同一想法在多個裝置上被同時編輯時，具有較新 updatedAt 時間戳的版本會覆寫舊版本
  - 不進行字段級別的合併（不複雜化邏輯）
  - 符合「簡單勝於複雜」原則，實現清晰且可預測

- **Q3: 數據遷移策略** → **A: 首次啟動自動遷移，失敗時回退到離線模式（選項 B）**
  - 應用程式首次啟動時偵測舊版本模擬數據
  - 自動將現有 7 個示例想法遷移到 SwiftData
  - 遷移時的 createdAt 和 updatedAt 使用當前系統時間
  - 遷移失敗時，應用程式回退到離線模式，允許使用者繼續使用，下次啟動時自動重試
  - 此策略確保平滑升級，無資料損失，無使用者中斷

- **Q4: 同步失敗恢復策略** → **A: 指數退避，3 次重試（選項 B）**
  - 同步失敗後自動重試 3 次，延遲間隔分別為 1 秒、2 秒、4 秒（指數退避）
  - 3 次重試後仍失敗則停止，在離線模式下保留變更，等待網路恢復或使用者手動操作
  - 每次同步失敗時向使用者顯示清晰的錯誤訊息和重試選項
  - 此策略確保 > 95% 的同步恢復率，同時避免伺服器過載和電池消耗

- **Q5: 時間戳精度與同步跨度** → **A: 毫秒精度，30 天未同步的舊版本標記為"已過時"但保留（選項 A）**
  - 所有時間戳（createdAt、updatedAt）使用毫秒精度存儲和比較
  - 版本控制和衝突解決均基於毫秒精度時間戳
  - 30 天未同步的版本標記為"已過時"但不自動刪除，供審計和恢復使用
  - 此策略提供足夠精度解決衝突，同時保留資料用於故障排查，符合簡單可靠的設計原則
