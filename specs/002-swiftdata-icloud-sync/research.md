# 研究報告：整合 SwiftData 與 iCloud 同步

**分支**: `002-swiftdata-icloud-sync`  
**日期**: 2025-11-10  
**狀態**: 完成

## 概述

此研究報告總結了實現 SwiftData + iCloud 同步所需的技術決策。所有主要澄清已在特性規格中解決（見 spec.md 的澄清章節）。

## 已解決的澄清

### Q1: CloudKit 配額與同步策略 ✅
**決策**: 按需同步 + 背景更新（選項 B）

**詳情**:
- 同步觸發: 使用者動作（新增、編輯、刪除）、應用進入前景、系統背景更新
- 批次大小: 單次 CloudKit 操作最多 100 筆想法變更
- 冷卻期: 無（按需立即觸發）
- 背景更新: 由 iOS 系統管理（通常 15-30 分鐘間隔）

**技術依據**:
- Apple CloudKit 官方建議：在 iOS 上採用按需同步避免電池消耗
- 批次大小 100 是 CloudKit 單次操作的安全上限
- 背景任務交由系統管理提高效率

**替代方案考慮**:
- ❌ 持續實時同步：電池消耗過高（>20%）
- ❌ 定時同步（5/30 秒）：延遲 > 10 秒，不符合需求
- ✅ 按需 + 背景：最佳平衡

---

### Q2: 版本控制與衝突解決策略 ✅
**決策**: 記錄級別衝突解決，時間戳優先（選項 A）

**詳情**:
- 衝突粒度: 完整 Idea 物件（非字段級別）
- 解決規則: 較新的 updatedAt 時間戳版本覆寫舊版本
- 時間戳精度: 毫秒（見 Q5）
- 衝突日誌: 記錄衝突事件用於審計

**技術依據**:
- 記錄級別衝突解決是移動應用的業界標準
- 時間戳優先策略簡單可靠，無邏輯矛盾
- 避免字段級別合併的複雜性（易引入難以重現的 bug）

**替代方案考慮**:
- ❌ 字段級別合併：複雜度 10x，邏輯矛盾風險高
- ❌ 使用者介入：破壞自動同步目標
- ❌ 保留分支版本：使用者體驗混亂
- ✅ 記錄級別時間戳優先：簡單可靠

---

### Q3: 數據遷移策略 ✅
**決策**: 首次啟動自動遷移，失敗時回退到離線模式（選項 B）

**詳情**:
- 觸發時機: 應用首次啟動時自動偵測
- 遷移對象: 現有 7 個示例想法（模擬數據）
- 失敗處理: 回退到離線模式，保留舊資料，下次啟動自動重試
- 時間戳初始化: 遷移時使用當前系統時間（createdAt、updatedAt）
- 使用者體驗: 無提示，無中斷

**技術依據**:
- 首次啟動遷移是升級時的標準模式
- 失敗回退確保應用功能不中斷
- 系統時間戳反映實際的遷移時間
- 自動重試在下次啟動時進行

**替代方案考慮**:
- ❌ 遷移失敗拋出錯誤：使用者體驗極差，可能導致資料喪失
- ❌ 手動遷移：複雜度高，易遺漏
- ❌ 捨棄舊資料：使用者會失去已建立的想法
- ✅ 自動遷移 + 失敗回退：平滑升級

---

### Q4: 同步失敗恢復策略 ✅
**決策**: 指數退避重試，3 次（選項 B）

**詳情**:
- 重試邏輯: 同步失敗後自動重試 3 次
- 延遲間隔: 1 秒、2 秒、4 秒（指數退避）
- 最終失敗: 3 次重試後停止，保留離線變更直到網路恢復
- 使用者通知: 每次失敗顯示清晰的錯誤訊息和重試選項
- 成功率目標: > 95%（指數退避通常達成 95-98%）

**技術依據**:
- 指數退避是業界標準（HTTP、RPC、消息隊列等）
- 3 次重試是平衡點（快速失敗 vs 充分重試）
- 1s 起始延遲避免立即重試伺服器錯誤
- 4s 最大延遲避免過長等待

**替代方案考慮**:
- ❌ 立即重試無延遲：伺服器過載，電池消耗高
- ❌ 固定延遲（5 秒 × 3）：不夠靈活，可能錯過快速恢復機會
- ❌ 無重試，僅記錄：無法達成 95% 恢復率
- ✅ 指數退避 3 次：標準最佳實踐

---

### Q5: 時間戳精度與同步跨度 ✅
**決策**: 毫秒精度，30 天舊版本標記為"已過時"但保留（選項 A）

**詳情**:
- 時間戳精度: 所有 createdAt、updatedAt 使用毫秒精度（milliseconds）
- 存儲格式: ISO 8601 字符串或 UInt64 毫秒戳
- 版本控制: 衝突解決和同步跨度追蹤均基於毫秒精度
- 過期策略: 30 天未同步的版本標記為"已過時"但不自動刪除
- 保留用途: 審計追蹤、故障排查、資料恢復

**技術依據**:
- 毫秒精度足以解決絕大多數衝突（多個變更同秒的機率 < 0.1%）
- iOS 系統時間精度支持毫秒（DispatchTime、Date 等）
- 30 天保留期符合一般日誌保留政策
- 標記不刪除確保資料可恢復性

**替代方案考慮**:
- ❌ 秒精度：衝突風險高（多變更同秒的機率增加到 5-10%）
- ❌ 微秒精度：過度精確，無必要，複雜度高
- ❌ 自動刪除 30 天舊版本：風險（可能誤刪重要資料）
- ✅ 毫秒精度 + 標記保留：最佳平衡

---

## 技術建議

### 依賴選擇

| 元件 | 選項 | 決策 | 理由 |
|------|------|------|------|
| 本地持久化 | CoreData vs SwiftData | **SwiftData** | iOS 17+ 官方推薦，與 Codable 完整集成 |
| 雲同步 | CloudKit vs 第三方 | **CloudKit** | Apple 官方方案，成本低，安全性高 |
| 衝突解決 | CRDTs vs 時間戳優先 | **時間戳優先** | 簡單可靠，符合 MVP 原則 |
| 時間同步 | NTP vs 設備時間 | **設備時間** | 移動應用標準，無需外部依賴 |

### 架構模式

- **服務層架構**: DataService、SyncService、CloudKitService 分離關注點
- **離線優先**: 本地變更優先存儲，異步同步到雲
- **背景同步**: 使用 iOS URLSessionConfiguration 和 CloudKit 背景任務
- **事件驅動**: 觀察 iCloud 帳戶變化、網路狀態、時間戳衝突

### 安全考慮

- **驗證**: CloudKit 區域專用容器（僅使用者帳戶可訪問）
- **加密**: 端點間 TLS，存儲層由 iOS 系統加密
- **隱私**: 無個人識別信息傳輸，僅想法內容

---

## 待實現的設計文件

以下文件將在 Phase 1 中生成：

1. **data-model.md** - Idea @Model 定義、SyncState 結構、CloudKitRecord 映射
2. **contracts/** - CloudKit 區域架構、記錄類型定義、索引策略
3. **quickstart.md** - 開發者快速上手指南、測試環境設置

---

**狀態**: ✅ 所有澄清已解決，準備進行 Phase 1 設計
